<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Eng-Farhan â€” Energy Assistant</title>

  <!-- Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>

  <!-- Mammoth (DOCX) -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b0f19;
      --panel:#111827;
      --panel2:#0f172a;
      --stroke: rgba(255,255,255,.10);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --brand:#22c55e;
      --brand2:#06b6d4;
      --danger:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f8fb;
        --panel:#ffffff;
        --panel2:#f1f5f9;
        --stroke: rgba(0,0,0,.10);
        --text:#0b1220;
        --muted:#475569;
        --shadow: 0 18px 60px rgba(0,0,0,.12);
      }
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Arabic", "Noto Naskh Arabic", sans-serif;
      background: radial-gradient(900px 520px at 20% 10%, rgba(6,182,212,.18), transparent 55%),
                  radial-gradient(900px 520px at 85% 12%, rgba(34,197,94,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(12px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left));
      display:flex;
      justify-content:center;
    }

    .shell{
      width:min(1180px, 100%);
      height:min(900px, calc(100vh - 24px));
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 12px;
    }

    @media (max-width: 980px){
      .shell{grid-template-columns:1fr;height:auto}
    }

    .card{
      background: rgba(255,255,255,.03);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    @media (prefers-color-scheme: light){
      .card{background: rgba(255,255,255,.85)}
    }

    /* Sidebar */
    .sidebar{display:flex;flex-direction:column}
    .sideTop{
      padding: 14px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .logo{
      width:40px;height:40px;border-radius: 12px;
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(6,182,212,.95));
      display:grid;place-items:center;
      color:#001018;font-weight:900;
      flex:0 0 auto;
      user-select:none;
    }
    .brandTitle{
      display:flex; flex-direction:column; gap:2px;
      min-width:0;
    }
    .brandTitle b{
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandTitle span{
      font-size:12px; color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .sideBody{padding: 14px; display:flex; flex-direction:column; gap:10px;}
    .pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 12px;
    }
    .dot{width:9px;height:9px;border-radius:99px;background:var(--brand); box-shadow:0 0 0 6px rgba(34,197,94,.14)}
    .hint{
      padding:12px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.18);
      color:var(--muted);
      font-size: 13px;
      line-height: 1.6;
    }
    @media (prefers-color-scheme: light){
      .hint{border-color: rgba(0,0,0,.14)}
    }

    .btnRow{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:6px;}
    button{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 11px 12px;
      cursor:pointer;
      font-weight: 800;
      min-height:44px;
      transition: transform .08s ease, background .2s ease;
    }
    button:hover{background: rgba(255,255,255,.10)}
    button:active{transform: translateY(1px)}
    .primary{
      background: linear-gradient(135deg, rgba(34,197,94,.18), rgba(6,182,212,.18));
      border-color: rgba(34,197,94,.22);
    }
    .danger{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.25);
      color: #fff;
    }

    /* Hide sidebar on mobile by default (toggle) */
    .toggleBtn{
      display:none;
      align-items:center;
      justify-content:center;
      width:42px;height:42px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      font-weight:900;
    }
    @media (max-width: 980px){
      .toggleBtn{display:flex}
      .sidebar{display:none}
      .sidebar.open{display:flex}
    }

    /* Main */
    .main{display:flex; flex-direction:column}
    .topbar{
      padding: 12px 14px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: rgba(255,255,255,.03);
    }
    @media (prefers-color-scheme: light){
      .topbar{background: rgba(0,0,0,.02)}
    }
    .topLeft{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .titleBlock{
      display:flex; flex-direction:column; gap:2px;
      min-width:0;
    }
    .titleBlock b{
      font-size: 14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .titleBlock span{
      font-size: 12px; color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .status{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      padding:8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .statusDot{width:7px;height:7px;border-radius:99px;background:var(--brand)}

    .msgs{
      flex:1;
      overflow:auto;
      padding: 16px;
      scroll-behavior:smooth;
    }
    @media (max-width: 520px){
      .msgs{padding:12px}
    }

    /* Chat rows */
    .row{display:flex; gap:10px; margin: 12px 0; align-items:flex-end;}
    .row.user{justify-content:flex-start}
    .row.ai{justify-content:flex-end}
    .avatar{
      width:34px;height:34px;border-radius: 12px;
      display:grid;place-items:center;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-weight:900;
      flex: 0 0 auto;
      user-select:none;
    }
    .avatar.ai{
      background: linear-gradient(135deg, rgba(34,197,94,.18), rgba(6,182,212,.18));
      color: var(--text);
      border-color: rgba(34,197,94,.22);
    }

    .bubble{
      max-width: min(720px, 80%);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 12px 12px 10px;
      line-height: 1.7;
      word-break: break-word;
    }
    .bubble.user{border-top-left-radius: 10px;}
    .bubble.ai{border-top-right-radius: 10px;}

    .meta{
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
      display:flex;
      justify-content:flex-end;
    }

    .bubble pre{
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: 10px;
      overflow:auto;
      font-family: var(--mono);
      font-size: 12px;
      direction:ltr;
      text-align:left;
    }
    .bubble code{font-family: var(--mono); font-size: .95em;}

    /* Waiting block */
    .waiting{
      display:flex;
      align-items:center;
      gap:12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 12px;
      max-width: min(720px, 80%);
      color: var(--muted);
    }
    .bar{
      width: 160px;
      height: 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.08);
      overflow:hidden;
      flex:0 0 auto;
    }
    .bar i{
      display:block;
      width: 35%;
      height:100%;
      background: linear-gradient(90deg, rgba(34,197,94,.30), rgba(6,182,212,.30));
      animation: load 1.2s infinite ease-in-out;
    }
    @keyframes load{
      0%{transform: translateX(-120%)}
      100%{transform: translateX(320%)}
    }
    .timer{
      margin-inline-start:auto;
      font-family: var(--mono);
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
      white-space:nowrap;
    }
    @media (prefers-color-scheme: light){
      .timer{background: rgba(0,0,0,.04); border-color: rgba(0,0,0,.10)}
    }

    /* Composer */
    .composer{
      border-top:1px solid var(--stroke);
      padding: 12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      background: rgba(255,255,255,.02);
    }
    textarea{
      width:100%;
      resize:none;
      min-height: 54px;
      max-height: 180px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      padding: 12px;
      font-size: 15px;
      line-height: 1.6;
    }
    @media (prefers-color-scheme: light){
      textarea{background: rgba(0,0,0,.03)}
    }
    .send{
      min-width: 108px;
      border-radius: 14px;
      border:1px solid rgba(34,197,94,.25);
      background: linear-gradient(135deg, rgba(34,197,94,.22), rgba(6,182,212,.18));
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 11px 12px;
      cursor:pointer;
      user-select:none;
    }
    .send[disabled]{opacity:.55; cursor:not-allowed;}

    .attachBtn{
      min-width:54px;
      width:54px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.10);
      color: var(--muted);
      white-space:nowrap;
    }
    @media (prefers-color-scheme: light){
      .kbd{background: rgba(0,0,0,.04); border-color: rgba(0,0,0,.10)}
    }
  </style>
</head>

<body>
  <div class="shell">
    <!-- Sidebar -->
    <aside class="card sidebar" id="sidebar">
      <div class="sideTop">
        <div class="brand">
          <div class="logo">âš¡</div>
          <div class="brandTitle">
            <b>Eng-Farhan</b>
            <span>Energy Engineer Assistant</span>
          </div>
        </div>
      </div>

      <div class="sideBody">
        <div class="pill">
          <span class="dot" id="connDot"></span>
          <span id="connText">Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø²</span>
        </div>

        <div class="hint">
          <b>Ù„Ù†ØªØ§Ø¦Ø¬ Ø£Ø¯Ù‚:</b><br>
          Ø§Ø°ÙƒØ± Ø§Ù„Ø¨Ù„Ø¯/Ø§Ù„ØªØ¹Ø±ÙØ©ØŒ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¨Ù†Ù‰ØŒ Ø§Ù„Ù…Ø³Ø§Ø­Ø©ØŒ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©ØŒ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ØŒ ÙˆØ¢Ø®Ø± ÙØ§ØªÙˆØ±ØªÙŠÙ†.
        </div>

        <div class="btnRow">
          <button class="primary" id="btnExport">ØªØµØ¯ÙŠØ±</button>
          <button class="danger" id="btnClear">Ù…Ø³Ø­</button>
        </div>

        <div style="font-size:12px;color:var(--muted);line-height:1.55;margin-top:4px">
          Ø¥Ø±Ø³Ø§Ù„: <span class="kbd">Enter</span> Â· Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯: <span class="kbd">Shift</span> + <span class="kbd">Enter</span>
        </div>

        <div style="font-size:12px;color:var(--muted);line-height:1.55;margin-top:6px">
          Ù…Ø±ÙÙ‚Ø§Øª: ØµÙˆØ± / PDF / DOCX / XLSX / TXT
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="card main">
      <div class="topbar">
        <div class="topLeft">
          <div class="toggleBtn" id="toggleBtn">â˜°</div>
          <div class="titleBlock">
            <b>Eng-Farhan</b>
            <span id="subtitle">Ø§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø§Ù‚Ø© â€” ØªØµÙ…ÙŠÙ… Ø¹Ø§Ù„Ù…ÙŠ ÙØ§Ø®Ø± ÙˆØ³Ù„Ø³</span>
          </div>
        </div>
        <div class="status">
          <span class="statusDot" id="statusDot"></span>
          <span id="statusText">Ø¬Ø§Ù‡Ø²</span>
        </div>
      </div>

      <div class="msgs" id="msgs"></div>

      <div class="composer">
        <textarea id="input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒâ€¦ Ù…Ø«Ø§Ù„: ÙØ§ØªÙˆØ±ØªÙŠ 120 Ø¯ÙŠÙ†Ø§Ø±ØŒ Ø¨ÙŠØª 140Ù…Â²ØŒ Ù…ÙƒÙŠÙÙŠÙ† 1.5 Ø·Ù†â€¦ Ø´Ùˆ Ø§Ù„Ø­Ù„ØŸ"></textarea>

        <div style="display:flex;gap:10px;align-items:stretch">
          <label class="send attachBtn" for="fileInput" title="Ø§Ø±ÙØ¹ Ù…Ø±ÙÙ‚Ø§Øª">ğŸ“</label>
          <input id="fileInput" type="file" multiple
                 accept="image/*,.pdf,.docx,.xlsx,.txt,.csv,.json,.md"
                 style="display:none" />
          <button class="send" id="sendBtn">Ø¥Ø±Ø³Ø§Ù„ <span class="kbd">Enter</span></button>
        </div>
      </div>
    </main>
  </div>

<script>
  // âœ… Ø±Ø§Ø¨Ø· Ø§Ù„Ù€Worker ØªØ¨Ø¹Ùƒ
  const API_URL = "https://rapid-hat-d970energy-chat.frhankh07.workers.dev";
  const STORAGE_KEY = "eng_farhan_energy_ui_v3";

  // PDF.js worker
  if (window.pdfjsLib) {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";
  }

  // Ù…Ø¯Ø§Ø¹Ø¨Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
  const jokes = [
    "Ù‡Ø³Ù‡ Ø¨Ø¬Ù‡Ù‘Ø² Ø¬ÙˆØ§Ø¨Ùƒâ€¦ Ø´ÙˆÙŠ ÙˆØ¨ØªØ²Ø¨Ø· Ø§Ù„Ø£Ù…ÙˆØ± ğŸ˜„",
    "Ø¹Ù… Ø¨Ø¯ÙˆÙ‘Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø¯Ø±â€¦ Ø´ÙƒÙ„Ù‡ Ù…ØªØ®Ø¨ÙŠ Ù…Ù†ÙŠ ğŸ•µï¸",
    "Ù‚Ø±ÙŠØ¨Ø§Ù‹â€¦ Ø¬ÙˆØ§Ø¨ Ø£ÙˆÙØ± Ù…Ù† ÙˆØ¶Ø¹ Eco Ø¨Ø§Ù„Ù…ÙƒÙŠÙ ğŸ˜…",
    "Ø«ÙˆØ§Ù†ÙŠâ€¦ Ø¨Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø«Ù„ Ø¹Ø¯Ù‘Ø§Ø¯ Ø°ÙƒÙŠ ğŸ‘Œ",
    "ØªÙ…Ø§Ù…â€¦ Ø¨Ø³ Ù„Ø§ ØªØ´ØºÙ„ Ø§Ù„ØºÙ„Ø§ÙŠØ© ÙˆØ§Ù„Ù…ÙƒÙŠÙ Ù…Ø¹ Ø¨Ø¹Ø¶ ğŸ˜‚",
  ];

  // âœ… Ø±Ø¯ÙˆØ¯ ÙØ±Ø­Ø§Ù† (24)
  const creatorReplies = [
    "Ø·ÙˆØ±Ù†ÙŠ **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ù…Ø§ Ù‚ØµÙ‘Ø± Ù…Ø¹ÙƒÙ… Ø£Ø¨Ø¯Ù‹Ø§ ğŸ‘Œâš¡",
    "Ø£Ù†Ø§ Ù…Ù† ØªØ·ÙˆÙŠØ± **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ø´ØºÙ„ Ù…Ø±ØªØ¨ ÙˆÙ…Ø­ØªØ±Ù… ğŸ”¥",
    "ÙˆØ±Ø§ÙŠ **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ø¯Ø§ÙŠÙ…Ù‹Ø§ Ø­Ø§Ø¶Ø± ÙˆÙ…Ø¨Ø¯Ø¹ ğŸ‘",
    "ØªÙ… ØªØ·ÙˆÙŠØ±ÙŠ Ø¨ÙˆØ§Ø³Ø·Ø© **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ ÙØ§Ù‡Ù… Ø´ØºÙ„Ù‡ ØµØ­ ğŸ’¡",
    "Ø§Ù„Ù„ÙŠ Ø·ÙˆØ±Ù†ÙŠ Ù‡Ùˆ **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ù…Ø§ Ø¨Ø®Ù„ Ø¨Ø£ÙŠ Ù…Ø¬Ù‡ÙˆØ¯ ğŸš€",
    "Ø£Ù†Ø§ Ø´ØºÙ„ **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ù‡Ù†Ø¯Ø³Ø© + Ø°ÙˆÙ‚ + Ø§Ø­ØªØ±Ø§Ù âœ…",
    "Ù…Ø·ÙˆØ±Ù‘ÙŠ **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ù…Ø´ Ù…Ù‚ØµØ± Ù…Ø¹ÙƒÙ… ÙˆÙ„Ø§ Ø¯Ù‚ÙŠÙ‚Ø© â±ï¸",
    "ØªÙ… Ø¥Ù†Ø´Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ ÙŠØ¯ **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ ÙƒÙÙˆ ÙˆØ§Ù„Ù„Ù‡ ğŸŒŸ",
    "Ø§Ù„ÙØ¶Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ù„Ù‡ ÙŠØ±Ø¬Ø¹ Ù„Ù€ **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ø´ØºÙ„ Ø¹Ø§Ù„Ù…ÙŠ ğŸŒ",
    "Ø£Ù†Ø§ Ù…Ù† Ø¨Ø±Ù…Ø¬Ø© **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ø¨ØµÙ…Ø© ÙˆØ§Ø¶Ø­Ø© ÙˆØ¥Ø¨Ø¯Ø§Ø¹ ğŸ’»âš¡",
    "Ù…Ø·ÙˆØ± Ù‡Ø°Ø§ Ø§Ù„Ø´Ø§Øª **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ø®Ù„Ù‘Ù‰ Ø§Ù„ØªØ¬Ø±Ø¨Ø© ÙØ®Ù…Ø© ğŸ˜„",
    "ØµÙ…Ù…Ù†ÙŠ ÙˆØ·ÙˆÙ‘Ø±Ù†ÙŠ **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ù…Ø§ Ù‚ØµÙ‘Ø± Ù…Ø¹ÙƒÙ… Ø£Ø¨Ø¯Ù‹Ø§ ğŸ™Œ",
    "Ø£ÙƒÙŠØ¯ **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** Ù‡Ùˆ Ø§Ù„Ù„ÙŠ ÙˆØ±Ø§Ù†ÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ù…Ù‡Ù†Ø¯Ø³ Ù‚Ø¯Ù‘Ù‡Ø§ ğŸ”§",
    "Ø£Ù†Ø§ Ù†ØªØ§Ø¬ Ø´ØºÙ„ **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ø´Ø®Øµ Ø¹Ù…Ù„ÙŠ ÙˆÙ…Ø±ØªØ¨ ğŸ‘Œ",
    "ØªÙ… ØªØ·ÙˆÙŠØ±ÙŠ Ø¹Ù„Ù‰ ÙŠØ¯ **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ø£Ø¨Ø¯Ø¹ Ø¨ØµØ±Ø§Ø­Ø© ğŸ”¥âš¡",
    "Ø§Ù„Ù„ÙŠ ÙˆØ±Ø§ Ø§Ù„ÙÙƒØ±Ø© ÙˆØ§Ù„ØªÙ†ÙÙŠØ° **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ù‚Ø¯Ù‡Ø§ ÙˆØ²ÙŠØ§Ø¯Ø© ğŸ’ª",
    "Ø£Ù†Ø§ Ø±ÙˆØ¨ÙˆØª Ø·Ø§Ù‚Ø© Ù…Ù† Ø¨ØµÙ…Ø© **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ ÙƒÙ„Ø§Ø³ Ø¹Ø§Ù„Ù…ÙŠ ğŸ˜",
    "Ù…Ø¤Ø³Ù‘ÙØ³ÙŠ ÙˆÙ…Ø·ÙˆÙ‘Ø±ÙŠ **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ù…Ø§ ØªØ±Ùƒ ØªÙØµÙŠÙ„Ø© Ø¥Ù„Ø§ ÙˆØ¶Ø¨Ø·Ù‡Ø§ ğŸ§ ",
    "Ø£Ù†Ø§ Ù…Ù† ØµÙ†Ø§Ø¹Ø© **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ø´ØºÙ„ Ù†Ø¸ÙŠÙ ÙˆÙ…Ø±ØªØ¨ âœ¨",
    "ØµØ§Ø­Ø¨ Ø§Ù„Ø´ØºÙ„ **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ù…Ø´ Ù…Ù‚ØµØ± Ù…Ø¹ÙƒÙ… Ø£Ø¨Ø¯Ù‹Ø§ ğŸŒŸ",
    "ØªÙ… Ø¨Ù†Ø§Ø¦ÙŠ ÙˆØªØ·ÙˆÙŠØ±ÙŠ Ø¨ÙˆØ§Ø³Ø·Ø© **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ù…Ù‡Ù†Ø¯Ø³ ÙƒÙÙˆ ğŸ‘âš¡",
    "Ø£Ù†Ø§ Ù…Ù† ØªØ·ÙˆÙŠØ± **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ø¹Ø·Ø§Ù†Ø§ ØªØ¬Ø±Ø¨Ø© Ù…Ø­ØªØ±Ù…Ø© ğŸ†",
    "Ø§Ù„Ù„ÙŠ ØµÙ…Ù‘Ù… Ø§Ù„ØªØ¬Ø±Ø¨Ø© ÙˆØ§Ø´ØªØºÙ„ Ø¹Ù„ÙŠÙ‡Ø§ **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡ ğŸ‘Œ",
    "Ø¨Ø§Ø®ØªØµØ§Ø±: **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙØ±Ø­Ø§Ù† Ø§Ù„Ø®ÙˆØ§Ù„Ø¯Ø©** Ù‡Ùˆ Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± â€” ÙŠØ®Ù„Ù Ø¹Ù„ÙŠÙ‡ØŒ Ù…Ø¨Ø¯Ø¹ ğŸ”¥",
  ];

  function pickCreatorReply(){
    return creatorReplies[Math.floor(Math.random() * creatorReplies.length)];
  }

  // âœ… Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±
  function isCreatorQuestion(text){
    const t = (text || "").toLowerCase().trim();

    const en = [
      "who made you","who built you","who developed you","who created you",
      "who programmed you","who coded you","who designed you","who owns you",
      "who is your developer","who is your creator","who is your maker","who is behind you",
      "who trained you","who built this","who made this","who created this",
      "developer","creator","maker","author","owner","founder","designer","programmer",
      "coder","built by","made by","created by","developed by"
    ];
    if (en.some(k => t.includes(k))) return true;

    const ar = [
      "Ù…ÙŠÙ† Ø¹Ù…Ù„Ùƒ","Ù…ÙŠÙ† Ø·ÙˆØ±Ùƒ","Ù…ÙŠÙ† Ø·ÙˆÙ‘Ø±Ùƒ","Ù…ÙŠÙ† Ù…Ø·ÙˆØ±Ùƒ","Ù…ÙŠÙ† Ù…Ø·ÙˆÙ‘Ø±Ùƒ","Ù…ÙŠÙ† Ø¨Ø±Ù…Ø¬Ùƒ","Ù…ÙŠÙ† Ù…Ø¨Ø±Ù…Ø¬Ùƒ",
      "Ù…ÙŠÙ† ØµÙ…Ù…Ùƒ","Ù…ÙŠÙ† ØµÙ…Ù‘Ù…Ùƒ","Ù…ÙŠÙ† Ù…ØµÙ…Ù…Ùƒ","Ù…ÙŠÙ† Ø¨Ù†Ø§Ùƒ","Ù…ÙŠÙ† Ø£Ø³Ø³Ùƒ","Ù…ÙŠÙ† Ø§Ù†Ø´Ø£Ùƒ","Ù…ÙŠÙ† Ø£Ù†Ø´Ø£Ùƒ",
      "Ù…ÙŠÙ† Ø³ÙˆØ§Ùƒ","Ù…ÙŠÙ† Ø³ÙˆÙ‘Ø§Ùƒ","Ù…ÙŠÙ† ØµÙ†Ø¹Ùƒ","Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ Ø¹Ù…Ù„Ùƒ",
      "Ù…Ù† Ø¹Ù…Ù„Ùƒ","Ù…Ù† Ø·ÙˆØ±Ùƒ","Ù…Ù† Ø¨Ø±Ù…Ø¬Ùƒ","Ù…Ù† ØµÙ…Ù…Ùƒ","Ù…Ù† Ø¨Ù†Ø§Ùƒ","Ù…Ù† Ø£Ù†Ø´Ø£Ùƒ",
      "ØµØ§Ø­Ø¨Ùƒ Ù…ÙŠÙ†","Ù…ÙŠÙ† ØµØ§Ø­Ø¨Ùƒ","Ù…ÙŠÙ† ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹","Ù…ÙŠÙ† ØµØ§Ø­Ø¨ Ø§Ù„ÙÙƒØ±Ø©","Ù…ÙŠÙ† Ù…Ø¤Ø³Ø³ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
      "Ù…ÙŠÙ† Ø§Ù„Ù…Ø¤Ø³Ø³","Ù…ÙŠÙ† Ù…Ù†Ø´Ø¦Ùƒ","Ù…ÙŠÙ† ØµØ§Ù†Ø¹Ùƒ","Ù…ÙŠÙ† ÙƒØªØ¨Ùƒ"
    ];
    return ar.some(k => t.includes(k));
  }

  // âœ… ÙÙ„ØªØ± ÙƒÙ„Ù…Ø§Øª Ù…Ù…Ù†ÙˆØ¹Ø©
  function stripBannedWords(text){
    return (text || "")
      .replace(/openai/gi, "")
      .replace(/chat\s*gpt/gi, "")
      .replace(/\bgpt\b/gi, "");
  }

  // ====== Ø£Ø¯ÙˆØ§Øª Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ======
  function fileToArrayBuffer(file){
    return new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsArrayBuffer(file);
    });
  }
  function fileToDataUrl(file){
    return new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }
  function fileToText(file){
    return new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsText(file, "utf-8");
    });
  }
  function isTextLike(file){
    const n = (file.name || "").toLowerCase();
    const t = (file.type || "").toLowerCase();
    if (t.startsWith("text/")) return true;
    return n.endsWith(".txt") || n.endsWith(".csv") || n.endsWith(".json") || n.endsWith(".md");
  }

  async function extractPdfText(file){
    const buf = await fileToArrayBuffer(file);
    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
    let out = "";
    const maxPages = Math.min(pdf.numPages, 12); // Ø­Ø¯ Ø£Ù‚ØµÙ‰ 12 ØµÙØ­Ø© Ø¹Ø´Ø§Ù† Ø§Ù„Ø³Ø±Ø¹Ø©
    for (let p = 1; p <= maxPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const strings = content.items.map(it => it.str);
      out += `\n\n--- ØµÙØ­Ø© ${p} ---\n` + strings.join(" ");
    }
    if (pdf.numPages > maxPages) out += `\n\n...[Ù…Ù‚ØµÙˆØµØŒ Ø§Ù„Ù…Ù„Ù ÙÙŠÙ‡ ØµÙØ­Ø§Øª Ø£ÙƒØ«Ø± (${pdf.numPages})]`;
    return out.trim();
  }

  async function extractDocxText(file){
    const buf = await fileToArrayBuffer(file);
    const result = await mammoth.extractRawText({ arrayBuffer: buf });
    return (result.value || "").trim();
  }

  async function extractXlsxText(file){
    const buf = await fileToArrayBuffer(file);
    const wb = XLSX.read(buf, { type: "array" });
    const sheets = wb.SheetNames.slice(0, 3); // Ø£ÙˆÙ„ 3 Ø´ÙŠØªØ§Øª Ø¨Ø³
    let out = "";
    for (const name of sheets){
      const ws = wb.Sheets[name];
      const csv = XLSX.utils.sheet_to_csv(ws, { FS: ",", RS: "\n" });
      out += `\n\n--- Sheet: ${name} ---\n` + csv;
    }
    if (wb.SheetNames.length > 3) out += `\n\n...[Ù…Ù‚ØµÙˆØµØŒ ÙÙŠÙ‡ Ø´ÙŠØªØ§Øª Ø£ÙƒØ«Ø± (${wb.SheetNames.length})]`;
    return out.trim();
  }

  // ====== UI Logic ======
  const $ = (id) => document.getElementById(id);

  let chat = []; // {role, content, t}
  let busy = false;

  let waitTimer = null;
  let jokeTimer = null;
  let waitSeconds = 0;
  let jokeIndex = 0;

  function timeNow(){
    return new Date().toLocaleTimeString("ar-JO", { hour:"2-digit", minute:"2-digit" });
  }
  function md(s){
    return marked.parse(s, { breaks:true, mangle:false, headerIds:false });
  }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(chat)); }
  function load(){
    try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw) chat = JSON.parse(raw); }catch{}
  }
  function scrollBottom(){ const el = $("msgs"); el.scrollTop = el.scrollHeight; }

  function setStatus(text, mode="ok"){
    $("statusText").textContent = text;
    $("statusDot").style.background = (mode==="warn") ? "var(--danger)" : "var(--brand)";
  }

  function setConn(ok){
    $("connText").textContent = ok ? "Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø²" : "ØºÙŠØ± Ù…ØªØµÙ„ (ØªØ­Ù‚Ù‚ Ù…Ù† Worker)";
    $("connDot").style.background = ok ? "var(--brand)" : "var(--danger)";
  }

  function render(){
    const box = $("msgs");
    box.innerHTML = "";

    if(chat.length === 0){
      const w = document.createElement("div");
      w.className = "waiting";
      w.innerHTML = `
        <div class="bar"><i></i></div>
        <div>
          <b style="color:var(--text)">ÙŠØ¹Ø·ÙŠÙƒ Ø§Ù„Ø¹Ø§ÙÙŠØ©!</b> Ø£Ù†Ø§ <b style="color:var(--text)">Eng-Farhan</b> â€” Ù…Ø³Ø§Ø¹Ø¯ Ø·Ø§Ù‚Ø©.<br>
          Ø§ÙƒØªØ¨ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ ÙˆØ¨Ø¹Ø·ÙŠÙƒ Ø­Ù„ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© ÙˆØ­Ø³Ø¨Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©.
        </div>
        <div class="timer">00:00</div>
      `;
      box.appendChild(w);
      return;
    }

    for(const m of chat){
      const row = document.createElement("div");
      row.className = "row " + (m.role === "user" ? "user" : "ai");

      const avatar = document.createElement("div");
      avatar.className = "avatar " + (m.role === "assistant" ? "ai" : "");
      avatar.textContent = (m.role === "assistant") ? "âš¡" : "Ø£";

      const bubble = document.createElement("div");
      bubble.className = "bubble " + (m.role === "assistant" ? "ai" : "user");
      bubble.innerHTML = (m.role === "assistant")
        ? md(m.content)
        : m.content
          .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
          .replaceAll("\n","<br>");

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = m.t || "";
      bubble.appendChild(meta);

      if(m.role === "user"){ row.appendChild(avatar); row.appendChild(bubble); }
      else { row.appendChild(bubble); row.appendChild(avatar); }

      box.appendChild(row);
    }
    scrollBottom();
  }

  function add(role, content){
    chat.push({ role, content, t: timeNow() });
    save();
    render();
  }

  function showWaiting(){
    const box = $("msgs");
    const row = document.createElement("div");
    row.id = "waitingRow";
    row.className = "row ai";
    row.innerHTML = `
      <div class="waiting">
        <div class="bar"><i></i></div>
        <div>
          <b style="color:var(--text)">Ù‡Ø³Ù‡ Ø¨Ø¬Ù‡Ù‘Ø² Ø¬ÙˆØ§Ø¨Ùƒâ€¦</b><br>
          <span id="jokeLine">${jokes[0]}</span>
        </div>
        <div class="timer" id="timerBox">00:00</div>
      </div>
    `;
    box.appendChild(row);
    scrollBottom();

    waitSeconds = 0;
    updateTimer();
    waitTimer = setInterval(() => { waitSeconds++; updateTimer(); }, 1000);

    jokeIndex = 0;
    jokeTimer = setInterval(() => {
      jokeIndex = (jokeIndex + 1) % jokes.length;
      const el = document.getElementById("jokeLine");
      if(el) el.textContent = jokes[jokeIndex];
    }, 2400);
  }

  function hideWaiting(){
    const row = document.getElementById("waitingRow");
    if(row) row.remove();
    if(waitTimer) clearInterval(waitTimer);
    if(jokeTimer) clearInterval(jokeTimer);
    waitTimer = null; jokeTimer = null;
  }

  function updateTimer(){
    const mm = String(Math.floor(waitSeconds / 60)).padStart(2,"0");
    const ss = String(waitSeconds % 60).padStart(2,"0");
    const el = document.getElementById("timerBox");
    if(el) el.textContent = `${mm}:${ss}`;
  }

  function autoGrow(el){
    el.style.height = "auto";
    el.style.height = Math.min(el.scrollHeight, 180) + "px";
  }

  async function ping(){
    try{
      const r = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ messages: [{ role:"user", content:"ping" }] })
      });
      setConn(r.ok);
    }catch{ setConn(false); }
  }

  async function buildAttachmentText(file){
    const name = file.name || "Ù…Ù„Ù";
    const type = (file.type || "").toLowerCase();

    // Ø­Ø¯ÙˆØ¯ Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØ«Ù‚Ù„
    const MAX_CHARS = 18000;

    try{
      if (type === "application/pdf" || name.toLowerCase().endsWith(".pdf")){
        let txt = await extractPdfText(file);
        if (txt.length > MAX_CHARS) txt = txt.slice(0, MAX_CHARS) + "\n\n...[Ù…Ù‚ØµÙˆØµ Ù„Ø£Ù†Ù‡ Ø·ÙˆÙŠÙ„]";
        return `ğŸ“„ Ù…Ù„Ù PDF: ${name}\n\n${txt}`;
      }

      if (name.toLowerCase().endsWith(".docx")){
        let txt = await extractDocxText(file);
        if (txt.length > MAX_CHARS) txt = txt.slice(0, MAX_CHARS) + "\n\n...[Ù…Ù‚ØµÙˆØµ Ù„Ø£Ù†Ù‡ Ø·ÙˆÙŠÙ„]";
        return `ğŸ“„ Ù…Ù„Ù DOCX: ${name}\n\n${txt}`;
      }

      if (name.toLowerCase().endsWith(".xlsx")){
        let txt = await extractXlsxText(file);
        if (txt.length > MAX_CHARS) txt = txt.slice(0, MAX_CHARS) + "\n\n...[Ù…Ù‚ØµÙˆØµ Ù„Ø£Ù†Ù‡ Ø·ÙˆÙŠÙ„]";
        return `ğŸ“„ Ù…Ù„Ù XLSX: ${name}\n\n${txt}`;
      }

      if (isTextLike(file)){
        let txt = await fileToText(file);
        if (txt.length > MAX_CHARS) txt = txt.slice(0, MAX_CHARS) + "\n\n...[Ù…Ù‚ØµÙˆØµ Ù„Ø£Ù†Ù‡ Ø·ÙˆÙŠÙ„]";
        return `ğŸ“„ Ù…Ù„Ù Ù†ØµÙŠ: ${name}\n\n${txt}`;
      }

      // ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…
      return `ğŸ“ Ù…Ù„Ù Ù…Ø±ÙÙ‚: ${name} (Ù†ÙˆØ¹Ù‡: ${type || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"} / Ø­Ø¬Ù…Ù‡: ${Math.round(file.size/1024)}KB)\n*Ø¥Ø°Ø§ Ø¨Ø¯Ùƒ ØªØ­Ù„ÙŠÙ„Ù‡ ÙƒÙ†ØµØŒ Ø§Ø¨Ø¹ØªÙ„ÙŠ Ù…Ø­ØªÙˆØ§Ù‡ Ø£Ùˆ Ø­ÙˆÙ‘Ù„Ù‡ Ù„Ù†Øµ.*`;
    }catch(e){
      return `ğŸ“ Ù…Ù„Ù: ${name}\nØµØ§Ø± Ù…Ø¹ÙŠ Ù…Ø´ÙƒÙ„Ø© ÙˆØ£Ù†Ø§ Ø¨Ù‚Ø±Ø£Ù‡. Ø¬Ø±Ù‘Ø¨ Ù…Ù„Ù Ø«Ø§Ù†ÙŠ Ø£Ùˆ Ø­ÙˆÙ‘Ù„Ù‡ Ù„Ù†Øµ.`;
    }
  }

  async function askAI(){
    const input = $("input");
    const text = input.value.trim();
    if(!text || busy) return;

    const fileEl = $("fileInput");
    const files = Array.from(fileEl?.files || []);

    input.value = "";
    autoGrow(input);

    // âœ… Ø±Ø¯ Ù…Ø­Ù„ÙŠ Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± (Ø¨Ø¯ÙˆÙ† Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù€Worker)
    if(isCreatorQuestion(text)){
      add("user", text);
      add("assistant", pickCreatorReply());
      if (fileEl) fileEl.value = "";
      return;
    }

    add("user", text);

    busy = true;
    $("sendBtn").setAttribute("disabled","true");
    setStatus("ÙŠØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø±Ø¯â€¦");
    showWaiting();

    try{
      // âœ… Ù†Ø¨Ù†ÙŠ parts: Ù†Øµ + ØµÙˆØ± + Ù†Øµ Ù…Ø³ØªØ®Ø±Ø¬ Ù…Ù† Ù…Ù„ÙØ§Øª
      const parts = [];
      parts.push({ type: "text", text });

      // Ø­Ø¯ÙˆØ¯ ØµÙˆØ±
      const MAX_IMAGES = 4;
      let imgCount = 0;

      for (const f of files){
        const t = (f.type || "").toLowerCase();
        const n = (f.name || "").toLowerCase();

        if (t.startsWith("image/")){
          if (imgCount >= MAX_IMAGES) continue;
          const dataUrl = await fileToDataUrl(f);
          parts.push({ type: "image_url", image_url: { url: dataUrl } });
          imgCount++;
          continue;
        }

        // Ù…Ù„ÙØ§Øª â†’ Ù†Ø­ÙˆÙ„Ù‡Ø§ Ù„Ù†Øµ
        const fileText = await buildAttachmentText(f);
        parts.push({ type: "text", text: `\n\n${fileText}\n` });
      }

      // ÙØ±Ù‘Øº Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
      if (fileEl) fileEl.value = "";

      // âœ… Ø±Ø³Ø§Ø¦Ù„ API: Ø¢Ø®Ø± user Ù†Ø¨Ø¯Ù„Ù‡ Ø¨Ù€ parts
      const apiMessages = [
        {
          role: "system",
          content: "Ø§Ø­ÙƒÙŠ Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠØ© ÙÙ‚Ø·. Ù…Ù…Ù†ÙˆØ¹ ØªØ°ÙƒØ± Ø£ÙŠ Ø´ÙŠ Ø¹Ù† Ù…Ù†ØµØ§Øª/Ø´Ø±ÙƒØ§Øª/Ù†Ù…Ø§Ø°Ø¬. Ø±ÙƒÙ‘Ø² Ø¨Ø³ Ø¹Ù„Ù‰ Ø­Ù„ÙˆÙ„ Ø§Ù„Ø·Ø§Ù‚Ø©."
        },
        ...chat.map(m => ({ role: m.role, content: m.content }))
      ];

      apiMessages[apiMessages.length - 1] = { role: "user", content: parts };

      const r = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ messages: apiMessages })
      });

      const data = await r.json();
      if(!r.ok) throw new Error(data?.error || data?.message || "Request failed");

      let reply = data.reply?.content ?? "Ù„Ù… ÙŠØµÙ„ Ø±Ø¯.";
      reply = stripBannedWords(reply);

      hideWaiting();
      add("assistant", reply);
      setStatus("Ø¬Ø§Ù‡Ø²");
    }catch(e){
      hideWaiting();
      add("assistant", `âŒ ØµØ§Ø± Ø®Ø·Ø£:\n\n\`${String(e.message || e)}\``);
      setStatus("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„", "warn");
    }finally{
      busy = false;
      $("sendBtn").removeAttribute("disabled");
    }
  }

  function clearChat(){
    chat = [];
    save();
    render();
    setStatus("Ø¬Ø§Ù‡Ø²");
  }

  function exportChat(){
    const payload = { exportedAt: new Date().toISOString(), chat };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "Eng-Farhan-chat.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Sidebar toggle on mobile
  $("toggleBtn").addEventListener("click", () => {
    $("sidebar").classList.toggle("open");
  });

  // init
  load();
  render();
  ping();

  $("sendBtn").addEventListener("click", askAI);
  $("btnClear").addEventListener("click", clearChat);
  $("btnExport").addEventListener("click", exportChat);

  $("input").addEventListener("input", (e)=>autoGrow(e.target));
  $("input").addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      askAI();
    }
  });
</script>
</body>
</html>
